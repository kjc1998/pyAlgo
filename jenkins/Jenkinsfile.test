pipeline {
    agent {
        docker {
            label 'docker'
            image 'docker.io/python:3.9'
        }
    }

    options {
        // only keeps last 10 builds
        buildDiscarder logRotator(
            artifactDaysToKeepStr: '',
            artifactNumToKeepStr: '10',
            daysToKeepStr: '',
            numToKeepStr: '10'
        )
    }

    environment { HOME='.' }

    stages {
        stage('Validate') {
            steps {
                script {
                    def targetBranches = ['main']
                    def target = env.CHANGE_TARGET

                    if (target != null && !targetBranches.contains(target)) {
                        currentBuild.result = 'ABORTED'
                        error('Abort Build')
                    }
                }
            }
        }
        stage('Setup') {
            steps { sh "export PATH:$HOME/.local/bin:$PATH" }
        }
        stage('Install') {
            steps { sh 'make devinstall VERSION=0.0.0' }
        }
        stage('Test') {
            steps { sh 'make tests' }
        }
    }
}